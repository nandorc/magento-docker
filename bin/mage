#!/bin/bash

cd $(echo "${0}" | sed -e "s/mage/../")
declare must_restart_web=0
[ ! -d ./var/magento-app ] && mkdir -p -v ./var/magento-app && must_restart_web=1
[ ! -d ./var/env-vars ] && mkdir -p -v ./var/env-vars && must_restart_web=1
[ ! -d ./var/varnish ] && mkdir -p -v ./var/varnish && must_restart_web=1
[ ! -f ./var/varnish/default.vcl ] && cp -v ./etc/varnish/default.vcl ./var/varnish/default.vcl && must_restart_web=1
[ ${must_restart_web} -eq 1 ] && docker compose restart web

[ ${#} -eq 0 ] && echo -e "ERR~ No command to execute" && exit 1

if [ "${1}" == "setup" ]; then
    # Create .bashrc and .bash_profile if needed on Git Bash
    if [ -n "${WINDIR}" ]; then
        if [ ! -f ~/.bash_profile ]; then
            echo "# generated by Git for Windows" >>~/.bash_profile
            echo "test -f ~/.profile && . ~/.profile" >>~/.bash_profile
            echo "test -f ~/.bashrc && . ~/.bashrc" >>~/.bash_profile
        fi
        if [ ! -f ~/.bashrc ]; then
            echo "[ -f ~/.bash_aliases ] && source ~/.bash_aliases" >>~/.bashrc
        fi
    fi

    alias_command='last_mage_path=""; [ -f ./mage ] && last_mage_path="./mage"; [ -f ./bin/mage ] && last_mage_path="./bin/mage"; [ -z "${last_mage_path}" ] && echo "ERR~ mage not found" || $last_mage_path'
    [ ! -f ~/.bash_aliases ] && touch ~/.bash_aliases
    [ -n "$(cat ~/.bash_aliases | grep "^alias mage=")" ] && sed -i -e "/^alias mage=/d" ~/.bash_aliases
    echo "alias mage='${alias_command}'" >>~/.bash_aliases

    if [ $? -eq 0 ]; then
        [ -n "${WINDIR}" ] && echo -e "WRN~ Must close and reopen window to apply changes or type 'source ~/.bash_aliases'" || newgrp
    fi
elif [ "${1}" == "bash" ]; then
    shift
    docker compose exec web bash -li
elif [ "${1}" == "mysql" ]; then
    shift
    docker compose exec db mysql ${@}
elif [ "${1}" == "varnish" ]; then
    shift
    docker compose exec -ti varnish bash
else
    docker compose ${@}
fi
exit 0
